name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cross-compilation dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: Install cross-compilation dependencies (macOS ARM64)
      if: matrix.os == 'macos-latest' && matrix.target == 'aarch64-apple-darwin'
      run: |
        # For macOS ARM64 cross-compilation, we need to set environment variables
        echo "OPENSSL_DIR=/opt/homebrew/opt/openssl@3" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/opt/homebrew/opt/openssl@3/lib/pkgconfig" >> $GITHUB_ENV

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build binary (native)
      if: matrix.target != 'aarch64-apple-darwin' || matrix.os != 'macos-latest'
      run: cargo build --release --target ${{ matrix.target }}

    - name: Build binary (macOS ARM64)
      if: matrix.target == 'aarch64-apple-darwin' && matrix.os == 'macos-latest'
      env:
        OPENSSL_STATIC: 1
        OPENSSL_DIR: /opt/homebrew/opt/openssl@3
        PKG_CONFIG_PATH: /opt/homebrew/opt/openssl@3/lib/pkgconfig
      run: cargo build --release --target ${{ matrix.target }}

    - name: Get tag name
      id: tag_name
      run: |
        echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Prepare binary (Unix)
      if: matrix.archive == 'tar.gz'
      run: |
        cd target/${{ matrix.target }}/release
        if [ -f plm ]; then
          strip plm || true
          tar -czf ../../../plm-${{ steps.tag_name.outputs.TAG_NAME }}-${{ matrix.target }}.tar.gz plm
        else
          echo "Binary not found!"
          ls -la
          exit 1
        fi

    - name: Prepare binary (Windows)
      if: matrix.archive == 'zip'
      run: |
        cd target/${{ matrix.target }}/release
        if (Test-Path plm.exe) {
          Compress-Archive -Path plm.exe -DestinationPath ../../../plm-${{ steps.tag_name.outputs.TAG_NAME }}-${{ matrix.target }}.zip
        } else {
          Write-Host "Binary not found!"
          Get-ChildItem
          exit 1
        }
      shell: powershell

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_name.outputs.TAG_NAME }}
        name: PLM ${{ steps.tag_name.outputs.TAG_NAME }}
        body: |
          ## PLM ${{ steps.tag_name.outputs.TAG_NAME }}
          
          ### ğŸš€ æ–°åŠŸèƒ½
          - æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
          - é…ç½®ç®¡ç†ç³»ç»Ÿ
          - CLI å·¥å…·
          
          ### ğŸ“¦ ä¸€é”®å®‰è£…
          ```bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | sh
          ```
          
          ### ğŸ“‹ æ‰‹åŠ¨ä¸‹è½½
          é€‰æ‹©é€‚åˆæ‚¨æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š
          - **Linux (x86_64)**: `plm-${{ steps.tag_name.outputs.TAG_NAME }}-x86_64-unknown-linux-gnu.tar.gz`
          - **macOS (Intel)**: `plm-${{ steps.tag_name.outputs.TAG_NAME }}-x86_64-apple-darwin.tar.gz`
          - **macOS (Apple Silicon)**: `plm-${{ steps.tag_name.outputs.TAG_NAME }}-aarch64-apple-darwin.tar.gz`
          - **Windows**: `plm-${{ steps.tag_name.outputs.TAG_NAME }}-x86_64-pc-windows-msvc.zip`
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          ```bash
          # åˆå§‹åŒ–é¡¹ç›®
          plm init --name my-project --path .
          
          # å‘ç°æ’ä»¶
          plm discover
          
          # å®‰è£…æ’ä»¶
          plm install plugin-name --version 1.0.0
          
          # æŸ¥çœ‹å¸®åŠ©
          plm --help
          ```
        draft: false
        prerelease: false
        files: |
          plm-${{ steps.tag_name.outputs.TAG_NAME }}-${{ matrix.target }}.*

